# load_module modules/ngx_http_brotli_filter_module.so;
# load_module modules/ngx_http_brotli_static_module.so;
# load_module modules/ngx_http_headers_more_filter_module.so;

daemon off;
error_log stderr notice;


# user                 root;
pid                  ./__nginx.pid;
worker_processes     auto;
worker_rlimit_nofile 65535;

events {
  use epoll;
  multi_accept       on;
  worker_connections 65535;
}

http {
  charset                utf-8;
  directio               1m;
  aio                    threads;  # currently works better than Linux AIO; used when file size >= [directio]
  sendfile               on;       # used when file size < [directio]
  tcp_nopush             on;
  tcp_nodelay            on;
  server_tokens          off;  # do not show nginx version 
  client_max_body_size   50M;


  # MIME
  include                mime.types;
  default_type           application/octet-stream;


  # Logging
  access_log          ./__access.log combined gzip=3 flush=1m;
  error_log           ./__error.log warn;
  # map "$time_local:$msec" $time_local_ms {
  #   ~(^\S+)(\s+\S+):\d+(\.\d+)$ $1$3$2;
  # }
  # log_format acclog '$time_local_ms  $remote_addr\t$status [$request] Host=$host Ref=$http_referer Len=$request_length=>$bytes_sent UA=[$http_user_agent] AccEnc=[$http_accept_encoding]';



  open_file_cache           max=512 inactive=60s;
  open_file_cache_valid     30s;
  open_file_cache_min_uses  1;
  open_file_cache_errors    off;

 


  ##### timeout between two consecutive read()/write()
  client_body_timeout   10s;
  client_header_timeout 10s;
  send_timeout          10s;
  keepalive_timeout         60s;
  reset_timedout_connection on;


  ##### buffers
  client_body_buffer_size 16k;


  # more_clear_headers Server Date Last-Modified;


  ##### do not apply limit to local ip addrs
  geo $is_public_ip {
    127.0.0.0/8     0;
    169.254.0.0/16  0;
    192.168.0.0/16  0;
    172.16.0.0/12   1;
    10.0.0.0/8      2;
    default         3;
  }

  ##### [$binary_remote_addr] filter
  map $is_public_ip $rate {
    0       0;
    default 5m;
  }

  ##### bytes/sec
  limit_rate       $rate;
  limit_rate_after 100m;


  # SSL
  ssl_session_timeout    1d;
  ssl_session_cache      shared:SSL:10m;
  ssl_session_tickets    off;  # Default value (on) violates forward secrecy 
  # quic_gso        on;       # Generic Segmentation Offloading

  # Mozilla Modern configuration
  ssl_protocols          TLSv1.3;

  # OCSP Stapling
  ssl_stapling           on;
  ssl_stapling_verify    on;
  resolver               1.1.1.1 1.0.0.1 [2606:4700:4700::1111] [2606:4700:4700::1001] 8.8.8.8 8.8.4.4 [2001:4860:4860::8888] [2001:4860:4860::8844] 208.67.222.222 208.67.220.220 [2620:119:35::35] [2620:119:53::53] 9.9.9.9 149.112.112.112 [2620:fe::fe] [2620:fe::9] 64.6.64.6 64.6.65.6 [2620:74:1b::1:1] [2620:74:1c::2:2] valid=60s;
  resolver_timeout       2s;


  # gzip
  gzip              on;
  gzip_vary         on;
  gzip_proxied      any;
  gzip_comp_level   6;
  gzip_static     on;
  gzip_types      text/css text/plain text/xml text/x-component text/javascript application/x-javascript application/javascript application/json application/manifest+json application/vnd.api+json application/xml application/xhtml+xml application/rss+xml application/atom+xml application/vnd.ms-fontobject application/x-font-ttf application/x-font-opentype application/x-font-truetype image/svg+xml image/x-icon image/vnd.microsoft.icon font/ttf font/eot font/otf font/opentype;

  # brotli
  brotli            on;
  # brotli_comp_level 11;  # Compression speed is important. Pre-compress big files if necessary.
  brotli_static     on;
  brotli_window     1m;
  brotli_types      text/css text/plain text/xml text/x-component text/javascript application/x-javascript application/javascript application/json application/manifest+json application/vnd.api+json application/xml application/xhtml+xml application/rss+xml application/atom+xml application/vnd.ms-fontobject application/x-font-ttf application/x-font-opentype application/x-font-truetype image/svg+xml image/x-icon image/vnd.microsoft.icon font/ttf font/eot font/otf font/opentype;















  


  # Block direct ip access
  server {
    listen      80 default_server;
    listen [::]:80 default_server;

    listen      443 default_server;
    listen [::]:443 default_server;
    ssl_reject_handshake on;

    server_name _;
    return 444;
  }

  # HTTP redirect
  server {
    listen      80 reuseport fastopen=256;  # v4
    # listen [::]:80 reuseport fastopen=256;  # v6

    location /.well-known/acme-challenge/ {
      root /var/wwwroot/;  # also change [WWW_ROOT] in [acme.sh]
    }

    location / {
     	return 301 https://$host$request_uri;
    }
  }

  # HTTPS/h2
  server {
    listen      443 ssl http2 reuseport fastopen=256;
    listen [::]:443 ssl http2 reuseport fastopen=256;
    # listen      443 http3 reuseport;  # udp v4
    # listen [::]:443 http3 reuseport;  # udp v6
    server_name         jerryc05.icu;

    ssl_certificate         /home/jerryc05/fullchain.pem;
    ssl_certificate_key     /home/jerryc05/key.pem;
    ssl_trusted_certificate /home/jerryc05/ca.pem; 

    # Web security (using [add_header] will overwrite outer scope definitions, DONT!)
    more_set_headers 'Strict-Transport-Security: max-age=31536000; includeSubDomains; preload';
    more_set_headers 'X-Content-Type-Options: nosniff';

    # Ban unknown referrer
    valid_referers none server_names;
    if ($invalid_referer) {
      return 444;
    }

    location / {
      return 200;
    }
  }
}